<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>GTA V‑Style Map • NZ‑only • Final+</title>
  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@3.0.2/Control.FullScreen.css" />
  <script src="https://unpkg.com/leaflet.fullscreen@3.0.2/Control.FullScreen.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
  <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css" />
  <script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.css" />
  <script src="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.js"></script>

  <script src="https://unpkg.com/leaflet-hash/leaflet-hash.js"></script>

  <!-- Esri raster (satellite) -->
  <script src="https://unpkg.com/esri-leaflet@3.0.11/dist/esri-leaflet.js"></script>

  <!-- Routing (OSRM) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <!-- Marker clustering for mobile perf -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#0b0d10; --panel:#161a20; --panel-2:#1b2028; --accent:#00ff7f; --accent2:#3ae2ff; --text:#f3f6fa;
      --hud-height:58px; --safe-bottom: env(safe-area-inset-bottom); --safe-top: env(safe-area-inset-top);
    }
    html,body,#app{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    #map{position:absolute;inset:0}

    /* GTA V HUD bar */
    .hud{
      position:fixed;top:calc(10px + var(--safe-top));left:10px;right:10px;height:var(--hud-height);display:flex;gap:10px;align-items:center;z-index:9999;
      background:linear-gradient(180deg,rgba(15,17,22,.92),rgba(9,11,16,.92));
      border:1px solid #2b3240;border-radius:14px;padding:10px;backdrop-filter:blur(8px);box-shadow:0 10px 25px rgba(0,0,0,.45);
    }
    .brand{font-weight:900;letter-spacing:.6px;text-transform:uppercase;font-size:14px}
    .money{margin-left:auto;font-weight:800;letter-spacing:.5px;color:var(--accent)}
    .chip{display:inline-flex;align-items:center;gap:8px;background:var(--panel-2);padding:8px 10px;border-radius:12px;border:1px solid #2c3344}
    .chip input{background:transparent;border:none;outline:none;color:var(--text);width:min(54vw,360px);font-size:14px}
    .chip button{background:var(--panel);color:var(--text);border:1px solid #2c3344;border-radius:10px;padding:9px 12px;cursor:pointer;font-size:14px}
    .chip .spinner{width:16px;height:16px;border:2px solid #2c3344;border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;display:none}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Control panel — slides to bottom on mobile */
    .panel{ position:fixed;right:10px;top:calc(var(--hud-height) + 20px + var(--safe-top));width:320px;max-height:calc(100% - var(--hud-height) - 36px - var(--safe-top));overflow:auto;z-index:9999;
      background:var(--panel);border:1px solid #2a3141;border-radius:16px;padding:12px;box-shadow:0 10px 25px rgba(0,0,0,.45)}
    .panel h3{margin:8px 6px 6px;font-size:14px;opacity:.85}
    .row{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px;border-radius:10px}
    .row:hover{background:var(--panel-2)}
    .row label{font-size:14px}
    .row input[type="checkbox"], .row input[type="radio"]{transform:scale(1.2)}
    .btn{display:inline-flex;align-items:center;gap:8px;background:var(--panel-2);padding:10px 12px;border-radius:10px;border:1px solid #2c3344;cursor:pointer;font-size:14px}

    /* Minimap radar */
    .minimap-frame{ position:fixed;left:10px;bottom:calc(10px + var(--safe-bottom));width:210px;height:210px;border-radius:50%;overflow:hidden;z-index:9999;
      box-shadow:0 0 0 6px rgba(17,20,28,.85),0 8px 28px rgba(0,0,0,.55);border:1px solid #2a3141;background:rgba(10,10,15,.5)}
    .legend{ position:fixed;left:230px;bottom:calc(18px + var(--safe-bottom));display:flex;gap:10px;flex-wrap:wrap;z-index:9999 }
    .legend .key{display:flex;align-items:center;gap:6px;background:var(--panel);border:1px solid #2a3141;border-radius:10px;padding:6px 8px}
    .dot{width:10px;height:10px;border-radius:50%}

    .leaflet-control{border-radius:10px!important;overflow:hidden}
    .leaflet-control, .leaflet-bar a{background:#121621;color:#fff;border-color:#2c3344}
    .leaflet-popup-content-wrapper,.leaflet-routing-container{background:#121621;color:#e8eef7;border:1px solid #2c3344;border-radius:14px}
    .leaflet-popup-tip{background:#121621}

    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:calc(20px + var(--safe-bottom)); background:#121621; color:#e8eef7; border:1px solid #2c3344; padding:10px 14px; border-radius:10px; display:none; z-index:9999; font-size:14px }

    /* iPhone layout tweaks (17 Pro Max ~430px wide) */
    @media (max-width: 480px){
      .hud{gap:8px; height:auto; flex-wrap:wrap; padding:8px}
      .brand{font-size:13px}
      .chip input{width:55vw}
      .panel{ left:10px; right:10px; width:auto; bottom:calc(230px + 18px + var(--safe-bottom)); top:unset; max-height:38vh }
      .minimap-frame{ width:180px; height:180px }
      .legend{ left:200px }
      .btn, .chip button{ padding:10px 12px; font-size:15px }
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="map"></div>

    <div class="hud">
      <div class="brand">GTA V Map (NZ)</div>
      <div class="chip" style="flex:1">
        <input id="searchBox" placeholder="Search places or stores (e.g. kmart)" />
        <div id="poiSpin" class="spinner" title="Loading…"></div>
        <button id="gpsBtn" title="Use my location">GPS</button>
        <button id="routeBtn" title="Route to pin">Route</button>
      </div>
      <div class="chip">
        <button id="shareBtn" title="Share view">Share</button>
        <button id="resetBtn" title="Reset">Reset</button>
        <button id="fullBtn" title="Fullscreen">Full</button>
      </div>
      <div class="money" id="moneyHUD">$9,999,999</div>
    </div>

    <div class="panel">
      <h3>Layers</h3>
      <div class="row"><label><input type="radio" name="basemap" value="street" checked> Street (Dark)</label></div>
      <div class="row"><label><input type="radio" name="basemap" value="light"> Street (Light)</label></div>
      <div class="row"><label><input type="radio" name="basemap" value="sat"> Satellite (Esri)</label></div>
      <div class="row"><label><input type="radio" name="basemap" value="topo"> Topographic</label></div>

      <h3>Overlays</h3>
      <div class="row"><label><input type="checkbox" id="rain"> Live Rain</label></div>
      <div class="row"><label><input type="checkbox" id="terrain"> Hillshade</label></div>
      <div class="row"><label><input type="checkbox" id="poi" checked> Points of Interest</label></div>

      <h3>Tools</h3>
      <div class="row"><button class="btn" id="measureBtn">Measure</button><span style="font-size:12px;opacity:.8">distance/area</span></div>
      <div class="row"><button class="btn" id="printBtn">Print</button><span style="font-size:12px;opacity:.8">save PDF</span></div>
      <div class="row"><button class="btn" id="dropPinBtn">Drop Pin</button><span style="font-size:12px;opacity:.8">quick marker</span></div>
    </div>

    <div class="minimap-frame"><div id="mini"></div></div>
    <div class="legend" id="legend"></div>
    <div class="toast" id="toast"></div>
  </div>

  <script>
    // -------------------- Helpers --------------------
    const showToast = (msg)=>{ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 2600); };
    const setSpin = (on)=>{ document.getElementById('poiSpin').style.display = on ? 'inline-block' : 'none'; };
    const debounce = (fn, ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); } };
    const haversine = (a,b)=>{ const R=6371000; const toRad = d=>d*Math.PI/180; const dLat=toRad(b.lat-a.lat); const dLon=toRad(b.lng-a.lng); const s1=Math.sin(dLat/2), s2=Math.sin(dLon/2); const aa = s1*s1 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2; return 2*R*Math.asin(Math.sqrt(aa)); };

    // -------------------- Basemaps --------------------
    const tiles = {
      street: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'© OSM © CARTO'}),
      light:  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{attribution:'© OSM © CARTO'}),
      topo:   L.tileLayer('https://tile.opentopomap.org/{z}/{x}/{y}.png',{attribution:'© OpenTopoMap, © OSM'}),
      sat:    L.esri.basemapLayer('Imagery')
    };

    // -------------------- Map init --------------------
    const map = L.map('map',{ center:[-36.8485,174.7633], zoom:12, zoomControl:true, layers:[tiles.street], fullscreenControl:false, tap:true });
    const hash = new L.Hash(map);

    // NZ bounds AFTER map init
    const nzBounds = L.latLngBounds([[-47.5,165.0],[-33.0,179.9]]);
    map.setMaxBounds(nzBounds);
    map.on('drag', () => map.panInsideBounds(nzBounds, { animate:false }));

    // Controls
    L.control.fullscreen({position:'topleft'}).addTo(map);
    L.control.locate({ position:'topleft', strings:{ title:'Show me where I am' }}).addTo(map);

    // Geocoder
    const geocoder = L.Control.Geocoder.nominatim();
    const searchBox = document.getElementById('searchBox');
    searchBox.addEventListener('keydown', (e)=>{ if(e.key==='Enter') smartSearch(searchBox.value); });
    document.getElementById('gpsBtn').onclick=()=>map.locate({setView:true,maxZoom:16, watch:true, enableHighAccuracy:true});

    let activeMarker = null; let lastKnownLoc = null;
    map.on('locationfound', (e)=>{ lastKnownLoc = { lat:e.latitude, lng:e.longitude }; });

    function doGeocode(q){
      return new Promise((resolve)=>{
        geocoder.geocode(q, (results)=> resolve(results||[]) );
      });
    }

    async function doSearch(q){
      const results = await doGeocode(q);
      if(!results.length){ showToast('No results'); return null; }
      const r = results[0];
      if(activeMarker) map.removeLayer(activeMarker);
      activeMarker = L.marker(r.center,{draggable:true}).addTo(map).bindPopup(`<b>${r.name||'Result'}</b><br>${r.html || ''}`).openPopup();
      map.setView(r.center, 16);
      return r.center;
    }

    // -------------------- Routing --------------------
    const router = L.Routing.control({
      waypoints: [],
      router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
      geocoder: L.Control.Geocoder.nominatim(),
      show:false, collapsible:true, addWaypoints:true,
      lineOptions:{ styles:[{color:'#00ff7f',opacity:.9,weight:6}] },
      altLineOptions:{ styles:[{color:'#3ae2ff',opacity:.6,weight:4}] }
    }).addTo(map);
    document.getElementById('routeBtn').onclick = ()=>{
      const center = map.getCenter();
      if(!activeMarker){ showToast('Drop/search a destination first'); return; }
      router.setWaypoints([ L.latLng(center.lat, center.lng), activeMarker.getLatLng() ]);
    };

    // Basemap switcher
    document.querySelectorAll('input[name="basemap"]').forEach(r=>{
      r.addEventListener('change',()=>{ Object.values(tiles).forEach(t=>map.removeLayer(t)); tiles[r.value].addTo(map); });
    });

    // Rain & Terrain overlays
    let rainLayer=null, shadeLayer=null;
    document.getElementById('rain').onchange = (e)=>{ if(e.target.checked){ rainLayer=L.tileLayer('https://tilecache.rainviewer.com/v2/radar/{z}/{x}/{y}/256/2/1_1.png',{opacity:.7,attribution:'RainViewer'}).addTo(map);} else if(rainLayer){ map.removeLayer(rainLayer); rainLayer=null; } };
    document.getElementById('terrain').onchange = (e)=>{ if(e.target.checked){ shadeLayer=L.tileLayer('https://tiles.wmflabs.org/hillshading/{z}/{x}/{y}.png',{opacity:.6,attribution:'Hillshade'}).addTo(map);} else if(shadeLayer){ map.removeLayer(shadeLayer); shadeLayer=null; } };

    // -------------------- NZ stores & amenities --------------------
    // Curated list (~120+) of common NZ chains/brands for brand/name matching
    const NZ_BRANDS = [
      'kmart','the warehouse','warehouse stationery','countdown','new world','pak\'n save','freshchoice','four square','countdown metro','new world metro',
      'briscoes','rebel sport','farmers','jb hi-fi','noel leeming','harvey norman','pb tech','mitre 10','bunnings','repco','supercheap auto',
      'bp','z energy','caltex','gull','night\'n day','mobil','challenge','waitomo',
      'mcdonald\'s','kfc','burger king','subway','domino\'s','pizza hut','hell pizza','burgerfuel','wendy\'s','pita pit','mexicali','sals authentic','tank juice','starbucks','coffee club','gloria jeans',
      'chemist warehouse','unichem','life pharmacy','green cross','countdown pharmacy',
      'liquorland','the bottle-o','super liquor','glengarry','big barrel',
      'animates','petstock','veterinary associates','vetora','carevets',
      'spark','2degrees','one nz','vodafone',
      'whitcoulls','paper plus','little unity','eddie\'s',
      'bruce mason centre','skycity','event cinemas','reading cinemas','timezone','zone bowling',
      'bendon','h&m','zara','cotton on','glassons','hallenstein brothers','decathlon','platypus','foot locker','puma','nike',
      'harry\'s','salvation army family store','habitat for humanity restore','save mart','paper plus','kathmandu','macpac','hunting & fishing',
      'the tool shed','jaycar','smiths city','miter10 mega','bargain chemist','countdown online pickup',
      'spotlight','bed bath & beyond','adairs','freedom','early settlers','target furniture','big save furniture',
      'harcourts','barfoot & thompson','bayleys','ray white',
      'pak n save fuel','costco','ikea',
      'aa centre','vtnz','vinz','drive vtnz','warrant of fitness',
      'resene','dulux','placemakers','itM','bldc','mile stone homes',
      'burger wisconsin','mad mex','popeyes','texas chicken',
      'bp connect','z espresso','caltex woolworths',
      'wharf road dairy','on the spot','super value','four square metro',
      'the coffee club','columbus coffee','mojo coffee','kokako coffee','flight coffee',
      'st pierre\'s sushi','edo sushi','sushi train','tank','habitual fix','wishbone','habit burger',
      'briscoes homeware','smith & caughey\'s',
      'harvey norman outlet','noel leeming clearance','pb tech outlet',
      'rebel sport outlet','nike factory','adidas outlet','platypus outlet',
      'domino\'s pickup','uber eats pickup','door dash pickup'
    ];

    // Amenity & shop filters (broad) so POIs show
    const AMENITY_WHITELIST = [
      'fast_food','cafe','restaurant','bar','pub','nightclub','fuel','parking','bank','atm','pharmacy','hospital','doctors','clinic','dentist','veterinary',
      'police','fire_station','school','college','university','library','toilets','place_of_worship','post_office','bus_station','ferry_terminal','cinema'
    ];
    const SHOP_WHITELIST = [
      'supermarket','convenience','department_store','clothes','shoes','sports','doityourself','hardware','electrical','electronics','mobile_phone','computer',
      'furniture','homeware','houseware','kitchen','outdoor','garden_centre','bicycle','beauty','hairdresser','chemist','books','stationery','toys',
      'pet','alcohol','bakery','butcher','seafood','greengrocer','deli','confectionery','mall','wholesale','variety_store'
    ];

    // -------------------- Overpass plumbing --------------------
    const poiCluster = L.markerClusterGroup({ maxClusterRadius:45, spiderfyOnMaxZoom:true, disableClusteringAtZoom:16 });
    const OVERPASS_ENDPOINTS = [
      'https://overpass-api.de/api/interpreter',
      'https://z.overpass-api.de/api/interpreter',
      'https://overpass.kumi.systems/api/interpreter'
    ];

    function rxEscape(s){return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}
    function toRegexUnion(arr){ return `^(?:${arr.map(rxEscape).join('|')})$`; }

    function composePOIQL(bounds){
      const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
      const amen = toRegexUnion(AMENITY_WHITELIST);
      const shop = toRegexUnion(SHOP_WHITELIST);
      const brands = `(?i)(?:${NZ_BRANDS.map(b=>rxEscape(b)).join('|')})`; // case-insensitive match
      const sections = [
        `node["amenity"~"${amen}"](${bbox});way["amenity"~"${amen}"](${bbox});relation["amenity"~"${amen}"](${bbox});`,
        `node["shop"~"${shop}"](${bbox});way["shop"~"${shop}"](${bbox});relation["shop"~"${shop}"](${bbox});`,
        `node["brand"~"${brands}"](${bbox});way["brand"~"${brands}"](${bbox});relation["brand"~"${brands}"](${bbox});`,
        `node["name"~"${brands}"](${bbox});way["name"~"${brands}"](${bbox});relation["name"~"${brands}"](${bbox});`
      ].join('');
      return `[out:json][timeout:25];(${sections});out center 200;`;
    }

    async function fetchOverpass(query){
      for(const url of OVERPASS_ENDPOINTS){
        try{ const res=await fetch(url,{method:'POST',mode:'cors',headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},body:new URLSearchParams({data:query})}); if(res.ok) return await res.json(); }catch(_){ }
        try{ const res=await fetch(`${url}?data=${encodeURIComponent(query)}`,{mode:'cors'}); if(res.ok) return await res.json(); }catch(_){ }
      }
      throw new Error('All Overpass endpoints failed');
    }

    async function renderPOIs(){
      setSpin(true);
      try{
        poiCluster.clearLayers();
        const json = await fetchOverpass(composePOIQL(map.getBounds()));
        if(!json || !json.elements) throw new Error('Empty response');
        json.elements.forEach(el=>{
          const lat = el.lat || (el.center && el.center.lat); const lon = el.lon || (el.center && el.center.lon); if(lat==null||lon==null) return;
          const tags = el.tags || {}; const name = tags.name || tags.brand || tags.amenity || tags.shop || 'POI';
          const marker = L.marker([lat,lon]);
          marker.bindPopup(`<b>${name}</b><br>${Object.entries(tags).slice(0,12).map(([k,v])=>`${k}: ${v}`).join('<br>')}`);
          poiCluster.addLayer(marker);
        });
        if(!map.hasLayer(poiCluster)) map.addLayer(poiCluster);
        if(poiCluster.getLayers().length===0) showToast('No POIs here — zoom out or pan');
      }catch(err){
        console.error('POI fetch failed', err); showToast('POI service busy — using offline samples');
        const samples=[
          {p:[-36.8710,174.7772], name:'Kmart St Lukes (sample)', brand:'Kmart'},
          {p:[-36.8493,174.7658], name:'PB Tech (sample)', brand:'PB Tech'},
          {p:[-36.8523,174.7684], name:'Countdown (sample)', brand:'Countdown'},
          {p:[-36.8472,174.7622], name:'The Warehouse (sample)', brand:'The Warehouse'}
        ];
        samples.forEach(s=>{ L.marker(s.p).bindPopup(`<b>${s.name}</b><br>brand: ${s.brand}`).addTo(poiCluster); });
        if(!map.hasLayer(poiCluster)) map.addLayer(poiCluster);
      } finally { setSpin(false); }
    }

    const refreshPOIs = debounce(()=>{ if(document.getElementById('poi').checked) renderPOIs(); }, 400);
    map.on('moveend', refreshPOIs);
    document.getElementById('poi').addEventListener('change',(e)=>{ if(e.target.checked){ renderPOIs(); map.addLayer(poiCluster);} else { map.removeLayer(poiCluster); poiCluster.clearLayers(); } });
    window.addEventListener('load', ()=>{ if(document.getElementById('poi').checked) renderPOIs(); });

    // -------------------- Smart search (brands first, nearest) --------------------
    function normalize(s){ return (s||'').toLowerCase().trim(); }
    function brandFromQuery(q){
      const nq = normalize(q);
      // best effort: exact, startsWith, includes
      if(NZ_BRANDS.includes(nq)) return nq;
      const starts = NZ_BRANDS.find(b=>nq.startsWith(b)); if(starts) return starts;
      const contains = NZ_BRANDS.find(b=> b.includes(nq) || nq.includes(b)); if(contains) return contains;
      return null;
    }

    function composeNearestBrandQL(lat,lng,brand){
      const brandRx = `(?i)${rxEscape(brand)}`;
      const radii = [3000,10000,30000,100000];
      // try growing radius to ensure at least one result
      const parts = radii.map(r=>`(node(around:${r},${lat},${lng})["brand"~"${brandRx}"];way(around:${r},${lat},${lng})["brand"~"${brandRx}"];relation(around:${r},${lat},${lng})["brand"~"${brandRx}"];node(around:${r},${lat},${lng})["name"~"${brandRx}"];way(around:${r},${lat},${lng})["name"~"${brandRx}"];relation(around:${r},${lat},${lng})["name"~"${brandRx}"];);`);
      return `[out:json][timeout:25];${parts.join('')}out center 200;`;
    }

    async function smartSearch(q){
      const brand = brandFromQuery(q);
      if(!brand){ // fall back to geocoder
        return await doSearch(q);
      }
      const origin = lastKnownLoc || { lat: map.getCenter().lat, lng: map.getCenter().lng };
      try{
        setSpin(true);
        const json = await fetchOverpass(composeNearestBrandQL(origin.lat, origin.lng, brand));
        if(!json || !json.elements || !json.elements.length){ showToast('No nearby store found'); return null; }
        // pick nearest by haversine
        let best = null; let bestD = Infinity;
        json.elements.forEach(el=>{
          const lat = el.lat || (el.center && el.center.lat); const lng = el.lon || (el.center && el.center.lon); if(lat==null||lng==null) return;
          const d = haversine(origin,{lat,lng}); if(d<bestD){ bestD=d; best={lat,lng,tags:el.tags||{}}; }
        });
        if(!best){ showToast('No nearby store found'); return null; }
        if(activeMarker) map.removeLayer(activeMarker);
        activeMarker = L.marker([best.lat,best.lng]).addTo(map).bindPopup(`<b>${best.tags.name || brand}</b><br>${Object.entries(best.tags).slice(0,10).map(([k,v])=>`${k}: ${v}`).join('<br>')}`).openPopup();
        map.setView([best.lat,best.lng], 16);
        return {lat:best.lat,lng:best.lng};
      }catch(err){ console.error('Brand search failed',err); showToast('Search service busy — try again'); return null; }
      finally{ setSpin(false); }
    }

    // -------------------- Tools --------------------
    let measureCtl=null; let measuring=false;
    document.getElementById('measureBtn').onclick=()=>{ if(!measuring){ measureCtl=L.control.measure({ primaryLengthUnit:'kilometers', secondaryLengthUnit:'meters', primaryAreaUnit:'hectares' }); measureCtl.addTo(map); measuring=true; } else { map.removeControl(measureCtl); measuring=false; } };
    document.getElementById('printBtn').onclick = ()=>window.print();
    document.getElementById('dropPinBtn').onclick = ()=>{ if(activeMarker) map.removeLayer(activeMarker); activeMarker=L.marker(map.getCenter(),{draggable:true}).addTo(map).bindPopup('Custom Pin').openPopup(); };
    document.getElementById('shareBtn').onclick = ()=>{ const c=map.getCenter(); const z=map.getZoom(); const url=`${location.origin}${location.pathname}#${z}/${c.lat.toFixed(5)}/${c.lng.toFixed(5)}`; navigator.clipboard.writeText(url).then(()=>showToast('Copied view URL')); };
    document.getElementById('resetBtn').onclick = ()=> map.setView([-36.8485,174.7633], 12);
    document.getElementById('fullBtn').onclick = ()=> map.toggleFullscreen();
    map.on('contextmenu', (e)=>{ const m=L.marker(e.latlng,{draggable:true}).addTo(map).bindPopup('Right‑click pin'); activeMarker=m; m.openPopup(); });

    // Minimap + YOU
    const miniLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
    const miniMap = new L.Control.MiniMap(miniLayer, { toggleDisplay:false, zoomLevelOffset:-4, aimingRectOptions:{ color:'#3ae2ff', weight:2 } });
    miniMap.addTo(map);
    document.getElementById('mini').appendChild(document.querySelector('.leaflet-control-minimap'));
    let miniLocLayer=null; function ensureMiniLocLayer(){ if(!miniLocLayer){ miniLocLayer=L.layerGroup().addTo(miniMap._miniMap);} return miniLocLayer; }
    map.locate({ watch:true, enableHighAccuracy:true, setView:false });
    map.on('locationfound', (e)=>{ const layer=ensureMiniLocLayer(); layer.clearLayers(); L.circleMarker(e.latlng,{radius:5,weight:2}).addTo(layer).bindTooltip('You'); });

    // Legend
    const legend=document.getElementById('legend');
    [['Route','#00ff7f'],['Alt Route','#3ae2ff'],['POI','#00ff7f'],['You','#000']].forEach(([label,color])=>{ const k=document.createElement('div'); k.className='key'; k.innerHTML=`<span class='dot' style='background:${color}'></span><span>${label}</span>`; legend.appendChild(k); });

    // Dev sanity tests
    (function testSuite(){
      console.assert(typeof map!=='undefined','Map defined');
      console.assert(map.options.maxBounds&&map.options.maxBounds.contains([-45.0312,168.6626]),'NZ bounds ok');
      console.assert(typeof miniMap!=='undefined','MiniMap exists');
      // Query builders
      const bb=L.latLngBounds([[-36.9,174.6],[-36.7,174.9]]);
      const ql=composePOIQL(bb); console.assert(/-36\.9,174\.6,-36\.7,174\.9/.test(ql),'POI QL bbox');
      const qb=composeNearestBrandQL(-36.85,174.76,'kmart'); console.assert(/kmart/i.test(qb),'Brand QL contains brand');
      // Brand matching
      console.assert(brandFromQuery('Kmart')==='kmart','Brand normalize');
    })();
  </script>
</body>
</html>
